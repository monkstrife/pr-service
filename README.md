# PR Reviewer Assignment Service

Сервис назначения ревьюверов для Pull Request’ов в командах разработки.

Реализует тестовое задание “Сервис назначения ревьюеров для Pull Request’ов (осенняя волна 2025)”.:contentReference[oaicite:0]{index=0}  

Сервис:

- создаёт команды и пользователей,
- автоматически назначает ревьюверов на PR,
- позволяет переназначать ревьюверов,
- возвращает список PR, назначенных конкретному ревьюверу,
- предоставляет статистику,
- поддерживает массовую деактивацию пользователей команды с безопасной переназначаемостью открытых PR.

---

## Стек

- **Язык**: Go
- **Хранилище**: SQLite (файловая БД)
- **HTTP**: chi (`github.com/go-chi/chi/v5`)
- **Логи**: `log/slog`
- **Контейнеризация**: Docker, docker-compose
- **Тесты (E2E)**: `github.com/gavv/httpexpect/v2`
- **Нагрузочное тестирование**: `hey`

---

## Доменные сущности

- **User**
  - `user_id` — внешний идентификатор (u1, u2, …)
  - `username`
  - `team_name`
  - `is_active` — активен ли пользователь, может ли быть ревьювером

- **Team**
  - `team_name` — уникальное имя команды
  - `members` — список пользователей

- **Pull Request**
  - `pull_request_id` — внешний ID (pr-1001, …)
  - `pull_request_name`
  - `author_id` — `user_id` автора
  - `status` — `OPEN` / `MERGED`
  - `assigned_reviewers` — список `user_id` (до 2)
  - `createdAt`, `mergedAt` — даты создания и merge

---

## Основные правила

- При создании PR назначаются **до двух** активных ревьюверов из **команды автора**, исключая самого автора.
- Переназначение заменяет одного ревьювера на случайного **активного** участника **из команды заменяемого** ревьювера (не автора и не уже назначенного).
- После статуса `MERGED` менять ревьюверов **нельзя**.
- Если доступных кандидатов меньше двух, назначается 0/1 ревьювер.
- Пользователь с `is_active = false` не назначается на ревью.
- `merge` реализован как **идемпотентный**.

---

## HTTP API

Реализация следует OpenAPI-спецификации (`openapi.yml`).

### Teams

- `POST /team/add`  
  Создать команду с участниками (создаёт/обновляет пользователей).

- `GET /team/get?team_name=...`  
  Получить команду с участниками.

- `POST /team/deactivateUsers`  
  Массовая деактивация пользователей команды + безопасная переназначаемость открытых PR.

### Users

- `POST /users/setIsActive`  
  Установить флаг активности пользователя.

- `GET /users/getReview?user_id=...`  
  Получить список PR, где пользователь назначен ревьювером.

### PullRequests

- `POST /pullRequest/create`  
  Создать PR и автоматически назначить до 2 ревьюверов из команды автора.

- `POST /pullRequest/merge`  
  Пометить PR как MERGED (идемпотентная операция).

- `POST /pullRequest/reassign`  
  Переназначить конкретного ревьювера на другого из его команды.

### Статистика
- `GET /stats`  
  Возвращает агрегированную статистику по PR и назначениям ревьюверов.

## Нагрузочное тестирование

Для проверки соблюдения SLI было проведено простое нагрузочное тестирование с помощью утилиты [`hey`](https://github.com/rakyll/hey).

### Конфигурация

- Окружение: Windows + Docker Desktop
- Параметры устройства сервера: AMD Ryzen 7 5800x3D + 32 GB RAM
- База данных: SQLite (файл, примонтированный в контейнер)
- Тестируемый сервис: один контейнер `pr-service`
- Предварительные данные:
  - 1 команда `load-team` с 3 участниками (`u1`, `u2`, `u3`)
  - ~20 открытых PR от автора `u1`

### /stats

```powershell
hey -z 30s -q 5 -c 5 "http://localhost:8080/stats"

Total:        30.0053 secs
Requests/sec: 24.9956
Average:      0.0027 secs
95%:          0.0036 secs
[200] 750 responses

~25 RPS в течение 30 секунд (750 запросов).
Средняя задержка ~2.7 ms.
95-й перцентиль < 4 ms.
Все ответы — HTTP 200.
Это на порядки лучше, чем требуемые 300 ms при 5 RPS.

### /getReview

```powershell
hey -z 30s -q 5 -c 5 "http://localhost:8080/users/getReview?user_id=u2"

Total:        30.0047 secs
Requests/sec: 24.9961
Average:      0.0027 secs
95%:          0.0035 secs
99%:          до ~0.0146 secs
[200] 750 responses

Снова ~25 RPS, 30 секунд.
Средняя задержка ~2.7 ms.
95% запросов укладываются до ~3.5 ms.
Даже “хвост” (99%) остаётся в районе 15 ms.
Ошибок нет.

### /create

```powershell
hey -z 10s -q 2 -c 2 `
    -m POST `
    -H "Content-Type: application/json" `
    -d "$prBody" `
    "http://localhost:8080/pullRequest/create"

Total:        30.0121 secs
Requests/sec: 399.8382
Average:      0.0070 secs
95%:          ~0.0103 secs
99%:          ~0.0140 secs
[200] 12000 responses

~400 RPS, 12 000 запросов за 30 секунд.
Средняя задержка ~7 ms.
95-й перцентиль ~10 ms.
99% запросов — до ~14 ms.
Все ответы — 200 OK.

То есть даже при нагрузке, которая в 80 раз выше заявленного 5 RPS, сервис остаётся в рамках нескольких миллисекунд по latency.